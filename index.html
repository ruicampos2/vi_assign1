<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Map - Data Visualization with Zoom</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; overflow: hidden; }
    .country { stroke: #333; stroke-width: 0.5px; }
    .active { fill: #ffcc00; }
    #info { 
      position: absolute; 
      left: 20px; 
      top: 20px; 
      background-color: #f9f9f9; 
      padding: 10px; 
      border: 1px solid #ccc; 
      z-index: 10; /* Mantém o painel sempre visível */
    }
    svg { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="info">
    <h2>Country Information</h2>
    <div id="details">Click on a country to see data.</div>
  </div>

  <script>
    var width = window.innerWidth, height = window.innerHeight;

    // Função para normalizar os nomes dos países
    function normalizeCountryName(name) {
      if (name) {
        return name.toLowerCase().replace(/ /g, '-'); // Converte para minúsculas e substitui espaços por hífens
      }
      return ''; // Retorna string vazia se o nome for indefinido
    }

    // Ajustando a escala e tradução da projeção para centralizar o mapa
    var projection = d3.geoMercator()
      .scale(150)
      .translate([width / 2, height / 1.5]);

    var path = d3.geoPath().projection(projection);

    var svg = d3.select("body").append("svg");

    // Criar o grupo onde os países serão adicionados
    var g = svg.append("g");

    // Adiciona comportamento de zoom e pan
    svg.call(d3.zoom()
      .scaleExtent([1, 8]) // Define os limites de zoom
      .on("zoom", function(event) {
        g.attr("transform", event.transform); // Aplica a transformação de zoom e pan ao grupo
      })
    );

    // Definir um esquema de cores para os países com base na taxa de obesidade
    var colorScale = d3.scaleQuantize()
      .domain([0, 50])
      .range(d3.schemeBlues[9]);

    // Carrega o mapa e os dados do CSV
    Promise.all([
      d3.json("https://d3js.org/world-110m.v1.json"),  // Mapa mundial
      d3.csv("dataset/dataset.csv")               // CSV com os dados
    ]).then(function([worldData, csvData]) {

      var countries = topojson.feature(worldData, worldData.objects.countries).features;

      // Cria um dicionário com base no CSV usando o ISO Code como chave
      var dataByCountry = {};
      csvData.forEach(function(d) {
        if (d['ISO Code']) {
          dataByCountry[d['ISO Code']] = d;
        }
      });

      // Desenha o mapa e aplica cores com base na taxa de obesidade
      g.selectAll("path")
        .data(countries)
        .enter().append("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("fill", function(d) {
          var countryCode = d.id;  // Código ISO numérico do país
          var countryData = dataByCountry[countryCode];
          return countryData ? colorScale(countryData['Obesity Rate(%)']) : "#ccc";  // Aplica a cor ou cinza se não houver dados
        })
        .on("click", function(event, d) {
          var countryCode = d.id;
          var countryData = dataByCountry[countryCode];

          if (countryData) {
            d3.select("#details").html(`
              <h3>${countryData.Country}</h3>
              <p>Obesity Rate: ${countryData['Obesity Rate(%)']}%</p>
              <p>Football Participation: ${countryData['Football(%)']}%</p>
              <p>Basketball Participation: ${countryData['Basketball(%)']}%</p>
              <p>Running Participation: ${countryData['Running(%)']}%</p>
            `);
          } else {
            d3.select("#details").html(`<p>No data available for this country</p>`);
          }
        });

    }).catch(function(error) {
      console.error("Erro ao carregar os dados: ", error);
    });
  </script>
</body>
</html>
